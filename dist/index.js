"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),__importDefault=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var fs_1=__importDefault(require("fs")),jimp_1=__importDefault(require("jimp")),escpos_1=__importDefault(require("escpos")),image_js_1=require("image-js"),replace_color_1=__importDefault(require("replace-color")),canny_edge_detector_1=__importDefault(require("canny-edge-detector")),ESCPOSImageProcessor=function(){function ESCPOSImageProcessor(e){var r=this;(0,_classCallCheck2.default)(this,ESCPOSImageProcessor),this.hasResized=!1,this.hasConverted=!1,this.path="",this.print=function(e,t){r.hasConverted&&escpos_1.default.Image.load(r.path,function(r){e.open(function(){t.align("lt").raster(r,"dwdh").cut().close()})})},this.convert=function(e,t){return new Promise(function(){var a=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee2(a,o){var s,n,i,u,l;return _regenerator.default.wrap(function _callee2$(c){for(;;)switch(c.prev=c.next){case 0:return r.path=t,r.hasResized=!1,c.next=4,jimp_1.default.read(e);case 4:s=c.sent,"good"==r.options.quality&&(n=r.getRatio(s),i=n.w,u=n.h,s.resize(i,u),r.hasResized=!0),l="./".concat(r.processId,"-org.png"),s.write(l,(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee(){var e,s,n;return _regenerator.default.wrap(function _callee$(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,image_js_1.Image.load(l);case 2:return e=i.sent,fs_1.default.unlinkSync(l),30,s=canny_edge_detector_1.default(e.grey(),{lowThreshold:30,highThreshold:30,gaussianBlur:3}),n="./".concat(r.processId,"-edges.png"),i.next=9,s.save(n);case 9:replace_color_1.default({image:n,colors:{type:"hex",targetColor:"#000000",replaceColor:"#00000000"}},function(e,s){if(fs_1.default.unlinkSync(n),e)return o(e);if(s.invert(),"best"==r.options.quality||!r.hasResized){var i=r.getRatio(s),u=i.w,l=i.h;s.resize(u,l),r.hasResized=!0}s.write(t,function(){r.hasConverted=!0,a(t)})});case 10:case"end":return i.stop()}},_callee)})));case 8:case"end":return c.stop()}},_callee2)}));return function(e,r){return a.apply(this,arguments)}}())},this.options=e||{quality:"best"},this.processId=this.genProcessId()}return(0,_createClass2.default)(ESCPOSImageProcessor,[{key:"genProcessId",value:function genProcessId(){for(var e="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=0;t<5;t++)e+=r.charAt(Math.floor(Math.random()*r.length));return e}},{key:"getRatio",value:function getRatio(e){var r=e.getWidth(),t=e.getHeight(),a=this.options.width||185;return{w:a,h:a*(t/r)}}}]),ESCPOSImageProcessor}();exports.default=ESCPOSImageProcessor;