"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_fs=_interopRequireDefault(require("fs")),_jimp=_interopRequireDefault(require("jimp")),_imageJs=require("image-js"),_replaceColor=_interopRequireDefault(require("replace-color")),_cannyEdgeDetector=_interopRequireDefault(require("canny-edge-detector")),ESCPOSImageProcessor=function(){function ESCPOSImageProcessor(e){(0,_classCallCheck2.default)(this,ESCPOSImageProcessor),this.options=void 0!==e?e:{quality:"best"},this.hasConverted=!1,this.hasResized=!1,this.path="",this.processID=this.genProcessID()}return(0,_createClass2.default)(ESCPOSImageProcessor,[{key:"print",value:function print(e,t){this.hasConverted&&escpos.Image.load(this.path,function(r){e.open(function(){t.align("lt").raster(r,"dwdh").cut().close()})})}},{key:"convert",value:function convert(e,t){var r=this;return new Promise(function(i,a){r.path=t,r.hasResized=!1,_jimp.default.read(e).then(function(e){if("good"==r.options.quality){var o=r.getRatio(e);e.resize(o.w,o.h),r.hasResized=!0}var s="./".concat(r.processID,"-org.png");e.write(s,function(){_imageJs.Image.load(s).then(function(e){_fs.default.unlinkSync(s);var o=(0,_cannyEdgeDetector.default)(e.grey(),{lowThreshold:30,highThreshold:30,gaussianBlur:3}),n="./".concat(r.processID,"-edges.png");o.save(n).then(function(){(0,_replaceColor.default)({image:n,colors:{type:"hex",targetColor:"#000000",replaceColor:"#00000000"}},function(e,o){if(_fs.default.unlinkSync(n),e)return a(e);if(o.invert(),"best"==r.options.quality||!r.hasResized){var s=r.getRatio(o);o.resize(s.w,s.h),r.hasResized=!0}o.write(t,function(){r.hasConverted=!0,i(t)})})}).catch(function(e){return a(e)})})})}).catch(function(e){return a(e)})})}},{key:"genProcessID",value:function genProcessID(){for(var e="",t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=0;r<5;r++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}},{key:"getRatio",value:function getRatio(e){var t=e.getWidth(),r=e.getHeight(),i=this.options.width||185;return{w:i,h:i*(r/t)}}}]),ESCPOSImageProcessor}();module.exports=ESCPOSImageProcessor;